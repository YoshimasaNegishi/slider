<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>全幅スライダー（上半分表示）</title>

<style>
    /* ========================================
       CSS変数（設定値の一元管理）
       ======================================== */
    :root {
        --slider-width: 4px;           /* スライダーバーの幅 */
        --slider-handle-size: 44px;    /* 丸ハンドルのサイズ */
        --slider-initial-pos: 50%;     /* 初期位置 */
        --aspect-ratio-padding: 40%;   /* アスペクト比（高さ/幅）*/
        --slider-color: #fff;          /* スライダーの色 */
        --bg-color: #111;              /* 背景色 */
    }

    body {
        margin: 0;
        background: var(--bg-color);
        font-family: sans-serif;
    }

    /* ★ ブラウザ幅いっぱい表示 */
    .comparison-container {
        width: 100vw;
        max-width: 100vw;
        margin: 0 calc(50% - 50vw);
        overflow: hidden;
        position: relative;
    }

    /* ★ 表示高さ決め
       padding-bottomハック: 幅に対する比率で高さを確保
       例: 40% = 高さが幅の40%（5:2のアスペクト比）*/
    .image-wrapper {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: var(--aspect-ratio-padding);
    }

    .image-before,
    .image-after {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;

        /* 上半分優先表示 */
        object-fit: cover;
        object-position: top center;

        /* 選択禁止 */
        user-select: none;
        -webkit-user-drag: none;
        pointer-events: none;

        /* GPUアクセラレーション有効化 */
        transform: translateZ(0);
        backface-visibility: hidden;
        will-change: clip-path;
    }

    .image-after {
        clip-path: inset(0 0 0 var(--slider-initial-pos));
    }

    /* スライダー本体 */
    .slider {
        position: absolute;
        top: 0;
        left: var(--slider-initial-pos);
        width: var(--slider-width);
        height: 100%;
        background: var(--slider-color);
        cursor: ew-resize;
        transform: translateX(-50%);
        z-index: 10;
        will-change: left;
    }

    /* スライダーの丸ハンドル */
    .slider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: var(--slider-handle-size);
        height: var(--slider-handle-size);
        border-radius: 50%;
        background: var(--slider-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    /* フォーカス時のスタイル（アクセシビリティ） */
    .slider:focus {
        outline: none;
    }
    .slider:focus-visible::before {
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.6), 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    /* 横画面全画面ボタン */
    .landscape-fullscreen-btn {
        position: fixed;
        top: 16px;
        right: 16px;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: all 0.3s ease;
        -webkit-tap-highlight-color: transparent;
    }

    .landscape-fullscreen-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
    }

    .landscape-fullscreen-btn:active {
        transform: scale(0.95);
    }

    /* スマホ縦向き時のみ表示 */
    @media (max-width: 768px) and (orientation: portrait) {
        .landscape-fullscreen-btn {
            display: flex;
        }
    }

    /* ボタンアイコン（SVG） */
    .landscape-fullscreen-btn svg {
        width: 24px;
        height: 24px;
        fill: none;
        stroke: white;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
    }
</style>
</head>
<body>

<div class="comparison-container" id="comparison" role="group" aria-label="画像比較スライダー">
    <div class="image-wrapper">
        <img class="image-before" id="img-before" src="before.jpg" alt="変更前の画像" />
        <img class="image-after" id="img-after" src="after.jpg" alt="変更後の画像" />
        <div class="slider"
             id="slider"
             role="slider"
             tabindex="0"
             aria-label="比較位置"
             aria-valuemin="0"
             aria-valuemax="100"
             aria-valuenow="50"
             aria-valuetext="50%"></div>
    </div>
</div>

<!-- 横画面全画面ボタン -->
<button class="landscape-fullscreen-btn" id="landscape-btn" aria-label="横画面で全画面表示">
    <svg viewBox="0 0 24 24">
        <path d="M9 4H5a2 2 0 0 0-2 2v4m0 4v4a2 2 0 0 0 2 2h4m6 0h4a2 2 0 0 0 2-2v-4m0-4V6a2 2 0 0 0-2-2h-4"/>
        <path d="M12 8v8" opacity="0.5"/>
        <path d="M16 12H8" opacity="0.5"/>
    </svg>
</button>

<script>
/**
 * 画像比較スライダーコンポーネント
 * IIFEでスコープを隔離し、グローバル汚染を防止
 */
(function() {
    'use strict';

    /* ========================================
       設定値
       ======================================== */
    const CONFIG = {
        INITIAL_POSITION: 50,    // 初期位置（%）
        MIN_POSITION: 0,         // 最小位置（%）
        MAX_POSITION: 100,       // 最大位置（%）
        KEYBOARD_STEP: 1,        // キーボード操作時の移動量（%）
        KEYBOARD_STEP_LARGE: 10  // Shift+矢印キーでの移動量（%）
    };

    /* ========================================
       状態管理
       ======================================== */
    const state = {
        isDragging: false,
        currentPosition: CONFIG.INITIAL_POSITION,
        containerRect: null,      // キャッシュされた座標
        rafId: null               // requestAnimationFrame ID
    };

    /* ========================================
       DOM要素の取得と検証
       ======================================== */
    const elements = {
        comparison: document.getElementById('comparison'),
        slider: document.getElementById('slider'),
        imgAfter: document.getElementById('img-after'),
        imgBefore: document.getElementById('img-before')
    };

    /**
     * 必須DOM要素の存在を検証
     * @returns {boolean} すべての要素が存在すればtrue
     */
    function validateElements() {
        const missing = Object.entries(elements)
            .filter(([, el]) => !el)
            .map(([name]) => name);

        if (missing.length > 0) {
            console.error('[Slider] 必須要素が見つかりません:', missing.join(', '));
            return false;
        }
        return true;
    }

    /* ========================================
       座標キャッシング
       ======================================== */
    /**
     * コンテナの座標をキャッシュ
     * リサイズ時に再計算される
     */
    function updateContainerRect() {
        state.containerRect = elements.comparison.getBoundingClientRect();
    }

    /* ========================================
       スライダー更新処理
       ======================================== */
    /**
     * スライダー位置を更新
     * @param {number} percentage - 位置（0-100%）
     */
    function setSliderPosition(percentage) {
        // 範囲を制限（0-100%）
        percentage = Math.max(CONFIG.MIN_POSITION, Math.min(CONFIG.MAX_POSITION, percentage));
        state.currentPosition = percentage;

        // DOM更新
        elements.slider.style.left = percentage + '%';
        elements.imgAfter.style.clipPath = `inset(0 0 0 ${percentage}%)`;

        // ARIA属性を更新（アクセシビリティ）
        elements.slider.setAttribute('aria-valuenow', Math.round(percentage));
        elements.slider.setAttribute('aria-valuetext', Math.round(percentage) + '%');
    }

    /**
     * X座標からスライダー位置を計算して更新
     * @param {number} clientX - マウス/タッチのX座標
     */
    function updateSliderFromX(clientX) {
        if (!state.containerRect || state.containerRect.width === 0) {
            updateContainerRect();
        }

        // ゼロ除算防止
        if (state.containerRect.width === 0) return;

        const offsetX = clientX - state.containerRect.left;
        const percentage = (offsetX / state.containerRect.width) * 100;
        setSliderPosition(percentage);
    }

    /**
     * requestAnimationFrameでスロットリングされた更新
     * @param {number} clientX - マウス/タッチのX座標
     */
    function throttledUpdate(clientX) {
        if (state.rafId) {
            cancelAnimationFrame(state.rafId);
        }
        state.rafId = requestAnimationFrame(() => {
            updateSliderFromX(clientX);
            state.rafId = null;
        });
    }

    /* ========================================
       イベントハンドラ
       ======================================== */
    /**
     * ドラッグ開始
     * @param {Event} e - イベントオブジェクト
     */
    function handleDragStart(e) {
        state.isDragging = true;
        updateContainerRect(); // ドラッグ開始時に座標を更新
        e.preventDefault();
    }

    /**
     * ドラッグ終了
     */
    function handleDragEnd() {
        state.isDragging = false;
        if (state.rafId) {
            cancelAnimationFrame(state.rafId);
            state.rafId = null;
        }
    }

    /**
     * マウス移動
     * @param {MouseEvent} e - マウスイベント
     */
    function handleMouseMove(e) {
        if (state.isDragging) {
            throttledUpdate(e.clientX);
        }
    }

    /**
     * タッチ移動
     * @param {TouchEvent} e - タッチイベント
     */
    function handleTouchMove(e) {
        if (state.isDragging && e.touches.length > 0) {
            e.preventDefault(); // スクロール防止
            throttledUpdate(e.touches[0].clientX);
        }
    }

    /**
     * キーボード操作
     * @param {KeyboardEvent} e - キーボードイベント
     */
    function handleKeyDown(e) {
        const step = e.shiftKey ? CONFIG.KEYBOARD_STEP_LARGE : CONFIG.KEYBOARD_STEP;
        let newPosition = state.currentPosition;

        switch (e.key) {
            case 'ArrowLeft':
            case 'Left':
                newPosition -= step;
                break;
            case 'ArrowRight':
            case 'Right':
                newPosition += step;
                break;
            case 'Home':
                newPosition = CONFIG.MIN_POSITION;
                break;
            case 'End':
                newPosition = CONFIG.MAX_POSITION;
                break;
            default:
                return; // 他のキーは無視
        }

        e.preventDefault();
        setSliderPosition(newPosition);
    }

    /* ========================================
       画像読み込みエラーハンドリング
       ======================================== */
    /**
     * 画像読み込みエラー時の処理
     * @param {string} imageName - 画像の識別名
     * @param {Event} e - エラーイベント
     */
    function handleImageError(imageName, e) {
        console.error(`[Slider] 画像の読み込みに失敗しました: ${imageName}`, e.target.src);
    }

    /* ========================================
       横画面全画面モード
       ======================================== */
    /**
     * 横画面全画面モードに切り替え
     */
    async function enterLandscapeFullscreen() {
        const landscapeBtn = document.getElementById('landscape-btn');

        try {
            // 全画面モードに入る
            const docElement = document.documentElement;
            if (docElement.requestFullscreen) {
                await docElement.requestFullscreen();
            } else if (docElement.webkitRequestFullscreen) {
                await docElement.webkitRequestFullscreen();
            } else if (docElement.mozRequestFullScreen) {
                await docElement.mozRequestFullScreen();
            } else if (docElement.msRequestFullscreen) {
                await docElement.msRequestFullscreen();
            }

            // 画面を横向きにロック（Screen Orientation API）
            if (screen.orientation && screen.orientation.lock) {
                try {
                    await screen.orientation.lock('landscape');
                } catch (err) {
                    console.log('[Slider] 画面の向きをロックできませんでした:', err.message);
                }
            }
        } catch (err) {
            console.error('[Slider] 全画面表示に失敗しました:', err);
        }
    }

    /**
     * 横画面全画面ボタンの初期化
     */
    function initializeLandscapeButton() {
        const landscapeBtn = document.getElementById('landscape-btn');
        if (!landscapeBtn) return;

        landscapeBtn.addEventListener('click', enterLandscapeFullscreen);

        // 全画面解除時の処理
        function handleFullscreenChange() {
            const isFullscreen = document.fullscreenElement ||
                                document.webkitFullscreenElement ||
                                document.mozFullScreenElement ||
                                document.msFullscreenElement;

            if (!isFullscreen && screen.orientation && screen.orientation.unlock) {
                // 全画面解除時に画面の向きロックを解除
                screen.orientation.unlock();
            }
        }

        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);
    }

    /* ========================================
       初期化
       ======================================== */
    function initialize() {
        // DOM要素の検証
        if (!validateElements()) {
            return;
        }

        // 初期座標をキャッシュ
        updateContainerRect();

        // 画像エラーハンドリング
        elements.imgBefore.addEventListener('error', (e) => handleImageError('before', e));
        elements.imgAfter.addEventListener('error', (e) => handleImageError('after', e));

        // マウスイベント
        elements.slider.addEventListener('mousedown', handleDragStart);
        document.addEventListener('mouseup', handleDragEnd);
        document.addEventListener('mousemove', handleMouseMove);

        // タッチイベント（passive: falseでpreventDefaultを有効化）
        elements.slider.addEventListener('touchstart', handleDragStart, { passive: false });
        document.addEventListener('touchend', handleDragEnd);
        document.addEventListener('touchmove', handleTouchMove, { passive: false });

        // キーボードイベント（アクセシビリティ）
        elements.slider.addEventListener('keydown', handleKeyDown);

        // リサイズ時に座標を再計算
        window.addEventListener('resize', updateContainerRect);

        // 横画面全画面ボタンの初期化
        initializeLandscapeButton();

        // 初期位置を設定
        setSliderPosition(CONFIG.INITIAL_POSITION);
    }

    // DOMContentLoaded後に初期化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
})();
</script>

</body>
</html>
